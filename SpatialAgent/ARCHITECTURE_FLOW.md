# SpatialAgent Agentic æ¶æ§‹è³‡æ–™å‚³éæµç¨‹

## ğŸ“Š æ•´é«”æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Input Data                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ test.json    â”‚  â”‚ RGB Image    â”‚  â”‚ RLE Mask Data       â”‚ â”‚
â”‚  â”‚ (question)   â”‚  â”‚ (PNG)        â”‚  â”‚ (JSON array)        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Phase 1: Initialization                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 1. Load Pre-trained Models                                â”‚  â”‚
â”‚  â”‚    - Distance Model (ResNet50)                           â”‚  â”‚
â”‚  â”‚    - Small Distance Model (for fine-grained)             â”‚  â”‚
â”‚  â”‚    - Inside Model (ResNet50 Binary)                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 2. Initialize Gemini Client (Vertex AI)                   â”‚  â”‚
â”‚  â”‚    - Model: gemini-2.5-flash                              â”‚  â”‚
â”‚  â”‚    - Temperature: 0.2                                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 3. Create tools_api instance                              â”‚  â”‚
â”‚  â”‚    - Register 9 spatial reasoning functions               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Phase 2: Data Preprocessing                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Input Item:                                                â”‚  â”‚
â”‚  â”‚ {                                                          â”‚  â”‚
â”‚  â”‚   "id": "xxx",                                             â”‚  â”‚
â”‚  â”‚   "image": "014324.png",                                   â”‚  â”‚
â”‚  â”‚   "rephrase_conversations": [{                             â”‚  â”‚
â”‚  â”‚     "value": "Which pallet is closest to <buffer_0>?"      â”‚  â”‚
â”‚  â”‚   }],                                                      â”‚  â”‚
â”‚  â”‚   "rle": [{...}, {...}]  // Mask RLE data                 â”‚  â”‚
â”‚  â”‚ }                                                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Parse Masks (parse_masks_from_conversation)              â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ 1. Extract mask references from question:              â”‚  â”‚
â”‚  â”‚    Regex: <([a-zA-Z]+)_(\d+)>                            â”‚  â”‚
â”‚  â”‚    Example: <buffer_0>, <pallet_1>                        â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ 2. Create Mask objects:                                 â”‚  â”‚
â”‚  â”‚    {                                                      â”‚  â”‚
â”‚  â”‚      "buffer_0": Mask(object_class="buffer",             â”‚  â”‚
â”‚  â”‚                       object_id=0,                        â”‚  â”‚
â”‚  â”‚                       region_id=0,                        â”‚  â”‚
â”‚  â”‚                       rle={...}),                        â”‚  â”‚
â”‚  â”‚      "pallet_1": Mask(...)                                â”‚  â”‚
â”‚  â”‚    }                                                      â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ 3. Store in tools_api.masks                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Set Image Path                                            â”‚  â”‚
â”‚  â”‚   tools_api.update_image('../data/test/images/014324.png')â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Phase 3: Agent Reasoning Loop (ReAct)                â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Step 1: Send Question to Gemini                          â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ Prompt Template:                                         â”‚  â”‚
â”‚  â”‚   "You are given several functions...                    â”‚  â”‚
â”‚  â”‚    dist(mask_1, mask_2): Returns distance...             â”‚  â”‚
â”‚  â”‚    closest(mask_1, [masks]): Returns closest...         â”‚  â”‚
â”‚  â”‚    ...                                                    â”‚  â”‚
â”‚  â”‚    <question>                                            â”‚  â”‚
â”‚  â”‚    Which pallet is closest to <buffer_0>?                â”‚  â”‚
â”‚  â”‚    </question>                                            â”‚  â”‚
â”‚  â”‚    Solve with <reasoning>, <execute>, <answer> format"   â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ messages = [                                             â”‚  â”‚
â”‚  â”‚   {"role": "user", "content": full_prompt}               â”‚  â”‚
â”‚  â”‚ ]                                                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Step 2: Gemini Response                                 â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ Response Format:                                         â”‚  â”‚
â”‚  â”‚   "<reasoning>                                           â”‚  â”‚
â”‚  â”‚    I need to find the closest pallet to buffer_0.        â”‚  â”‚
â”‚  â”‚    I should use the closest() function.                  â”‚  â”‚
â”‚  â”‚    </reasoning>                                          â”‚  â”‚
â”‚  â”‚    <execute>                                             â”‚  â”‚
â”‚  â”‚    closest(buffer_0, [pallet_0, pallet_1])                â”‚  â”‚
â”‚  â”‚    </execute>"                                           â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ messages.append({"role": "assistant",                    â”‚  â”‚
â”‚  â”‚                  "content": response_text})             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Step 3: Parse <execute> Tag                              â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ Regex: <execute>(.*?)</execute>                          â”‚  â”‚
â”‚  â”‚ Extract: "closest(buffer_0, [pallet_0, pallet_1])"       â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ Call: _execute_function(command)                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Step 4: Execute Function                                 â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ Parse:                                                    â”‚  â”‚
â”‚  â”‚   func_name = "closest"                                  â”‚  â”‚
â”‚  â”‚   args_str = "buffer_0, [pallet_0, pallet_1]"            â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ Resolve Arguments (AST parsing):                         â”‚  â”‚
â”‚  â”‚   - buffer_0 â†’ Mask object from self.masks               â”‚  â”‚
â”‚  â”‚   - pallet_0 â†’ Mask object                               â”‚  â”‚
â”‚  â”‚   - pallet_1 â†’ Mask object                               â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ Call: tools_api.closest(buffer_0_mask,                    â”‚  â”‚
â”‚  â”‚                         [pallet_0_mask, pallet_1_mask])    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Step 5: Tool Function Execution                          â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ Example: closest() function                              â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ 1. Load RGB image:                                       â”‚  â”‚
â”‚  â”‚    Image.open(img_path) â†’ RGB (HÃ—WÃ—3)                    â”‚  â”‚
â”‚  â”‚    Resize to (360, 640)                                   â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ 2. Decode masks:                                         â”‚  â”‚
â”‚  â”‚    mask_0.decode_mask() â†’ numpy array (HÃ—W)              â”‚  â”‚
â”‚  â”‚    Resize masks to (360, 640)                            â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ 3. Prepare batch input:                                  â”‚  â”‚
â”‚  â”‚    For each candidate mask:                              â”‚  â”‚
â”‚  â”‚      Stack: [RGB, mask_A, mask_B] â†’ (3+1+1)Ã—HÃ—W           â”‚  â”‚
â”‚  â”‚    Batch: NÃ—(5Ã—360Ã—640)                                  â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ 4. Model Inference:                                     â”‚  â”‚
â”‚  â”‚    distance_model(batch_tensor) â†’ [dist1, dist2, ...]    â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ 5. Find minimum:                                        â”‚  â”‚
â”‚  â”‚    argmin(distances) â†’ pallet_1                          â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ 6. Return: "pallet_1"                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Step 6: Send Result Back to Gemini                       â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ messages.append({"role": "user",                         â”‚  â”‚
â”‚  â”‚                  "content": "pallet_1"})                  â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ Continue loop (back to Step 2)                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Step 7: Final Answer                                      â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ Gemini Response:                                          â”‚  â”‚
â”‚  â”‚   "<answer>pallet_1</answer>"                            â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ Extract: "pallet_1"                                      â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ Format Answer:                                           â”‚  â”‚
â”‚  â”‚   - If answer matches mask name â†’ return region_id       â”‚  â”‚
â”‚  â”‚   - Otherwise â†’ return answer as-is                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Phase 4: Model Inference Details                 â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Distance Estimation (dist/closest)                      â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ Input Preparation:                                       â”‚  â”‚
â”‚  â”‚   RGB Image:     (HÃ—WÃ—3)  â†’ Resize â†’ (360Ã—640Ã—3)        â”‚  â”‚
â”‚  â”‚   Mask 1:        (HÃ—W)    â†’ Resize â†’ (360Ã—640Ã—1)         â”‚  â”‚
â”‚  â”‚   Mask 2:        (HÃ—W)    â†’ Resize â†’ (360Ã—640Ã—1)         â”‚  â”‚
â”‚  â”‚   Stack:         (360Ã—640Ã—5)                             â”‚  â”‚
â”‚  â”‚   Tensor:        (1Ã—5Ã—360Ã—640)                           â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ Model Forward:                                           â”‚  â”‚
â”‚  â”‚   ResNet50(input_tensor) â†’ distance (float)              â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ Cascade Strategy:                                        â”‚  â”‚
â”‚  â”‚   if distance < 300cm:                                  â”‚  â”‚
â”‚  â”‚     Use small_dist_model (fine-grained)                  â”‚  â”‚
â”‚  â”‚     if distance < 25cm:                                 â”‚  â”‚
â”‚  â”‚       return 0.0                                        â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ Output: distance / 100.0 (convert to meters)            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Inside Classification (inside)                          â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ Input Preparation:                                       â”‚  â”‚
â”‚  â”‚   RGB Image:     (HÃ—WÃ—3)  â†’ Resize â†’ (360Ã—640Ã—3)         â”‚  â”‚
â”‚  â”‚   Mask A:        (HÃ—W)    â†’ Resize â†’ (360Ã—640Ã—1)          â”‚  â”‚
â”‚  â”‚   Mask B:        (HÃ—W)    â†’ Resize â†’ (360Ã—640Ã—1)          â”‚  â”‚
â”‚  â”‚   Stack:         (360Ã—640Ã—5)                             â”‚  â”‚
â”‚  â”‚   Batch:         (NÃ—5Ã—360Ã—640)                           â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ Model Forward:                                           â”‚  â”‚
â”‚  â”‚   ResNet50Binary(batch_tensor) â†’ logits (NÃ—1)            â”‚  â”‚
â”‚  â”‚   sigmoid(logits) â†’ probabilities (NÃ—1)                  â”‚  â”‚
â”‚  â”‚   round(probabilities) â†’ predictions (0 or 1)            â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ Output: count of predictions == 1                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Geometric Functions (is_left, is_right, etc.)          â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ Simple centroid calculation:                             â”‚  â”‚
â”‚  â”‚   centroid = mean(x_indices), mean(y_indices)            â”‚  â”‚
â”‚  â”‚   Compare x-coordinates for left/right                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Phase 5: Output Formatting                         â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Format Final Answer                                      â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ 1. Send answer_preamble to Gemini:                       â”‚  â”‚
â”‚  â”‚    "Now, provide the final answer..."                    â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ 2. Get formatted answer:                                 â”‚  â”‚
â”‚  â”‚    "pallet_1" or "2.5" or "left"                         â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ 3. Map to region_id if needed:                           â”‚  â”‚
â”‚  â”‚    If answer in masks â†’ return masks[answer].region_id  â”‚  â”‚
â”‚  â”‚    Otherwise â†’ return answer                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Save Results                                              â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ test.json:                                                â”‚  â”‚
â”‚  â”‚   [                                                       â”‚  â”‚
â”‚  â”‚     {"id": "xxx", "normalized_answer": "pallet_1"},      â”‚  â”‚
â”‚  â”‚     ...                                                   â”‚  â”‚
â”‚  â”‚   ]                                                       â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ test_convs.json:                                         â”‚  â”‚
â”‚  â”‚   [                                                       â”‚  â”‚
â”‚  â”‚     {                                                     â”‚  â”‚
â”‚  â”‚       "id": "xxx",                                       â”‚  â”‚
â”‚  â”‚       "normalized_answer": "pallet_1",                    â”‚  â”‚
â”‚  â”‚       "conversation": [messages...]                      â”‚  â”‚
â”‚  â”‚     },                                                    â”‚  â”‚
â”‚  â”‚     ...                                                   â”‚  â”‚
â”‚  â”‚   ]                                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ è³‡æ–™æµè©³ç´°èªªæ˜

### 1. è¼¸å…¥è³‡æ–™çµæ§‹

```python
Input Item = {
    "id": str,                    # å”¯ä¸€è­˜åˆ¥ç¢¼
    "image": str,                 # åœ–ç‰‡æª”å (e.g., "014324.png")
    "rephrase_conversations": [{
        "value": str              # å•é¡Œæ–‡æœ¬ (e.g., "Which pallet is closest to <buffer_0>?")
    }],
    "rle": [                     # RLE ç·¨ç¢¼çš„ mask è³‡æ–™
        {
            "size": [H, W],
            "counts": str        # RLE ç·¨ç¢¼å­—ä¸²
        },
        ...
    ]
}
```

### 2. Mask è§£ææµç¨‹

```
Question Text: "Which pallet is closest to <buffer_0>?"
                    â†“
Regex Pattern: <([a-zA-Z]+)_(\d+)>
                    â†“
Matches: [("buffer", "0")]
                    â†“
Create Mask Object:
    Mask(
        object_class="buffer",
        object_id=0,
        region_id=0,
        rle=rle_data[0]
    )
                    â†“
Store in Dictionary:
    masks = {
        "buffer_0": Mask(...)
    }
```

### 3. ReAct å°è©±å¾ªç’°

```
Iteration 1:
    User â†’ Gemini: "Question + Tool descriptions"
    Gemini â†’ Agent: "<reasoning>...</reasoning><execute>closest(...)</execute>"
    Agent â†’ Tools: Execute closest()
    Tools â†’ Agent: "pallet_1"
    Agent â†’ Gemini: "pallet_1"

Iteration 2:
    Gemini â†’ Agent: "<answer>pallet_1</answer>"
    Agent â†’ Return: "pallet_1"
```

### 4. å·¥å…·å‡½æ•¸åŸ·è¡Œæµç¨‹

```
Function Call: closest(buffer_0, [pallet_0, pallet_1])
                    â†“
1. Resolve Arguments:
   buffer_0 â†’ Mask object from masks dict
   pallet_0 â†’ Mask object
   pallet_1 â†’ Mask object
                    â†“
2. Load & Preprocess:
   - Load RGB image
   - Decode masks from RLE
   - Resize all to (360, 640)
                    â†“
3. Prepare Batch:
   For each candidate:
     Stack: [RGB, buffer_mask, candidate_mask]
     Shape: (5, 360, 640)
   Batch: (2, 5, 360, 640)
                    â†“
4. Model Inference:
   distance_model(batch) â†’ [2.5, 1.8]
                    â†“
5. Find Minimum:
   argmin([2.5, 1.8]) â†’ index 1
   Return: "pallet_1"
```

### 5. æ¨¡å‹è¼¸å…¥è¼¸å‡ºè¦æ ¼

| Model | Input Shape | Output Shape | Purpose |
|-------|------------|--------------|---------|
| Distance Model | (1, 5, 360, 640) | (1,) | é æ¸¬å…©å€‹ç‰©é«”è·é›¢ |
| Small Distance Model | (1, 5, 360, 640) | (1,) | ç²¾ç´°è·é›¢é æ¸¬ (<3m) |
| Inside Model | (N, 5, 360, 640) | (N, 1) | åˆ¤æ–·åŒ…å«é—œä¿‚ |
| Gemini | Text (prompt) | Text (response) | æ¨ç†èˆ‡æ±ºç­– |

### 6. è³‡æ–™è½‰æ›é»

```
1. RLE â†’ numpy array:
   pycocotools.mask.decode(rle) â†’ (H, W) binary array

2. Image â†’ Tensor:
   PIL Image â†’ numpy â†’ torch.Tensor â†’ GPU

3. Mask Name â†’ Mask Object:
   "buffer_0" â†’ masks["buffer_0"] â†’ Mask instance

4. Answer â†’ region_id:
   "pallet_1" â†’ masks["pallet_1"].region_id â†’ int
```

## ğŸ¯ é—œéµè¨­è¨ˆç‰¹é»

1. **åˆ†é›¢é—œæ³¨é»**ï¼š
   - Gemini: é«˜å±¤æ¨ç†èˆ‡æ±ºç­–
   - DL Models: ç²¾ç¢ºçš„ç©ºé–“è¨ˆç®—
   - Tools: ä»‹é¢å±¤ï¼Œçµ±ä¸€å‡½æ•¸èª¿ç”¨

2. **å¯æ“´å±•æ€§**ï¼š
   - æ–°å¢å·¥å…·å‡½æ•¸åªéœ€åœ¨ `func_map` è¨»å†Š
   - æ¨¡å‹æ›¿æ›ä¸å½±éŸ¿ Agent é‚è¼¯

3. **éŒ¯èª¤è™•ç†**ï¼š
   - åœ–ç‰‡ä¸å­˜åœ¨ â†’ è·³éä¸¦æ¨™è¨˜ "-1"
   - API éŒ¯èª¤ â†’ é¡¯ç¤ºæç¤ºä¸¦è·³é
   - JSON æå£ â†’ è‡ªå‹•ä¿®å¾©æˆ–é‡æ–°é–‹å§‹

4. **ç‹€æ…‹ç®¡ç†**ï¼š
   - `masks`: ç•¶å‰å•é¡Œçš„æ‰€æœ‰ mask ç‰©ä»¶
   - `messages`: å°è©±æ­·å²
   - `img_path`: ç•¶å‰è™•ç†çš„åœ–ç‰‡è·¯å¾‘

